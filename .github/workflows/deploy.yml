name: Deploy AI Security Demo to Azure

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-security-rg
  AZURE_LOCATION: eastus
  ACR_NAME: aisecurityacr
  MCP_SERVER_NAME: mcp-server
  CONTAINER_ENV_NAME: ai-security-env
  STATIC_WEB_APP_NAME: ai-security-demo

jobs:
  # Job 1: Build and Deploy MCP Server
  deploy-mcp-server:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Deploy MCP Server to Azure Container Apps
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install MCP Server Dependencies
        run: |
          cd mcp-server
          npm install

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group (if not exists)
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags environment=production project=ai-security-demo

      - name: Create Azure Container Registry (if not exists)
        run: |
          if ! az acr show --name ${{ env.ACR_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
            echo "Creating Azure Container Registry..."
            az acr create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.ACR_NAME }} \
              --sku Basic \
              --admin-enabled true
          else
            echo "Azure Container Registry already exists"
          fi

      - name: Build and Push Docker Image to ACR
        run: |
          # Login to ACR
          az acr login --name ${{ env.ACR_NAME }}
          
          # Build Docker image
          cd mcp-server
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/mcp-server:${{ github.sha }} .
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/mcp-server:latest .
          
          # Push to ACR
          docker push ${{ env.ACR_NAME }}.azurecr.io/mcp-server:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/mcp-server:latest

      - name: Create Container Apps Environment (if not exists)
        run: |
          if ! az containerapp env show --name ${{ env.CONTAINER_ENV_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
            echo "Creating Container Apps Environment..."
            az containerapp env create \
              --name ${{ env.CONTAINER_ENV_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --location ${{ env.AZURE_LOCATION }}
          else
            echo "Container Apps Environment already exists"
          fi

      - name: Get ACR Credentials
        id: acr-creds
        run: |
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)
          echo "::add-mask::$ACR_PASSWORD"
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT

      - name: Deploy/Update MCP Server Container App
        run: |
          if az containerapp show --name ${{ env.MCP_SERVER_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
            echo "Updating existing Container App..."
            az containerapp update \
              --name ${{ env.MCP_SERVER_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/mcp-server:${{ github.sha }}
          else
            echo "Creating new Container App..."
            az containerapp create \
              --name ${{ env.MCP_SERVER_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --environment ${{ env.CONTAINER_ENV_NAME }} \
              --image ${{ env.ACR_NAME }}.azurecr.io/mcp-server:${{ github.sha }} \
              --target-port 8080 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 10 \
              --registry-server ${{ env.ACR_NAME }}.azurecr.io \
              --registry-username ${{ steps.acr-creds.outputs.username }} \
              --registry-password ${{ steps.acr-creds.outputs.password }} \
              --secrets \
                azure-openai-endpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }} \
                azure-openai-key=${{ secrets.AZURE_OPENAI_API_KEY }} \
              --env-vars \
                AZURE_OPENAI_ENDPOINT=secretref:azure-openai-endpoint \
                AZURE_OPENAI_API_KEY=secretref:azure-openai-key \
                AZURE_OPENAI_DEPLOYMENT=${{ secrets.AZURE_OPENAI_DEPLOYMENT }} \
                AZURE_OPENAI_API_VERSION=${{ secrets.AZURE_OPENAI_API_VERSION }} \
                PORT=8080 \
                NODE_ENV=production
          fi

      - name: Get MCP Server URL
        id: mcp-url
        run: |
          MCP_URL=$(az containerapp show \
            --name ${{ env.MCP_SERVER_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "MCP Server URL: https://$MCP_URL"
          echo "url=https://$MCP_URL" >> $GITHUB_OUTPUT

      - name: Update MCP Server CORS Settings
        run: |
          # Wait for Static Web App to be deployed first (will update in next job)
          echo "MCP Server deployed successfully"
          echo "URL: ${{ steps.mcp-url.outputs.url }}"

    outputs:
      mcp-server-url: ${{ steps.mcp-url.outputs.url }}

  # Job 2: Build and Deploy Static Web App
  deploy-static-web-app:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    needs: deploy-mcp-server
    name: Build and Deploy Static Web App
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_MCP_SERVER_ENDPOINT: ${{ needs.deploy-mcp-server.outputs.mcp-server-url }}
          VITE_MCP_API_KEY: ${{ secrets.MCP_API_KEY }}

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Static Web App (if not exists)
        id: create-swa
        run: |
          if ! az staticwebapp show --name ${{ env.STATIC_WEB_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
            echo "Creating Static Web App..."
            az staticwebapp create \
              --name ${{ env.STATIC_WEB_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --location ${{ env.AZURE_LOCATION }} \
              --sku Free \
              --source https://github.com/${{ github.repository }} \
              --branch main \
              --app-location "/" \
              --output-location "dist" \
              --login-with-github
          else
            echo "Static Web App already exists"
          fi

      - name: Get Static Web App deployment token
        id: swa-token
        run: |
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.apiKey -o tsv)
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          output_location: "dist"
          skip_app_build: true

      - name: Get Static Web App URL
        id: swa-url
        run: |
          SWA_URL=$(az staticwebapp show \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query defaultHostname -o tsv)
          echo "Static Web App URL: https://$SWA_URL"
          echo "url=https://$SWA_URL" >> $GITHUB_OUTPUT

      - name: Configure Static Web App Settings
        run: |
          az staticwebapp appsettings set \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --setting-names \
              VITE_MCP_SERVER_ENDPOINT=${{ needs.deploy-mcp-server.outputs.mcp-server-url }} \
              VITE_MCP_API_KEY=${{ secrets.MCP_API_KEY }}

    outputs:
      static-web-app-url: ${{ steps.swa-url.outputs.url }}

  # Job 3: Update CORS and Final Configuration
  configure-services:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [deploy-mcp-server, deploy-static-web-app]
    name: Configure CORS and Services
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Update MCP Server CORS Settings
        run: |
          az containerapp update \
            --name ${{ env.MCP_SERVER_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --set-env-vars \
              ALLOWED_ORIGINS=${{ needs.deploy-static-web-app.outputs.static-web-app-url }},http://localhost:3000

      - name: Test MCP Server Health
        run: |
          echo "Testing MCP Server health endpoint..."
          curl -f ${{ needs.deploy-mcp-server.outputs.mcp-server-url }}/health || echo "Health check failed"

      - name: Deployment Summary
        run: |
          echo "🚀 Deployment Complete!"
          echo "================================"
          echo "📦 MCP Server URL: ${{ needs.deploy-mcp-server.outputs.mcp-server-url }}"
          echo "🌐 Static Web App URL: ${{ needs.deploy-static-web-app.outputs.static-web-app-url }}"
          echo "================================"
          echo "Next steps:"
          echo "1. Visit your Static Web App to test the application"
          echo "2. Check Azure Portal for monitoring and logs"
          echo "3. Configure custom domain if needed"

  # Job 4: Close Pull Request
  close-pull-request:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Static Web App deployment token
        id: swa-token
        run: |
          SWA_TOKEN=$(az staticwebapp secrets list \
            --name ${{ env.STATIC_WEB_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.apiKey -o tsv)
          echo "::add-mask::$SWA_TOKEN"
          echo "token=$SWA_TOKEN" >> $GITHUB_OUTPUT

      - name: Close Pull Request
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.token }}
          action: "close"
